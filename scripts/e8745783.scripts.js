"use strict";function Recipe(){this.fromRecords=function(a){this.stages=new Array;for(var b=0;b<a.length;b++){var c=a[b],d=new Object;d.ingredients=c.get("ingredients"),d.steps=c.get("steps"),d.id=c.getId(),d.order=c.get("stageid"),this.stages.push(d)}this.name=c.get("name"),this.chapter=c.get("chapter"),this.date=c.get("date")},this.fromRecord=function(a){this.id=a.getId(),this.name=a.get("name"),this.chapter=a.get("chapter"),this.date=a.get("date")},this.new=function(){this.name="New Recipe",this.chapter="Starter",this.stages=new Array,this.date=new Date;for(var a=0;1>a;a++){var b=new Object;b.ingredients="Ingredients\n",b.steps="Steps\n",b.order=a,this.stages.push(b)}},this.toRecords=function(){for(var a=new Array,b=0;b<this.stages.length;b++){var c=this.stages[b],d={ingredients:c.ingredients,steps:c.steps,stageid:c.order,chapter:this.chapter,name:this.name,date:this.date};c.id&&(d.id=c.id),a.push(d)}return a},this.delStage=function(){console.log(this.stages.length,this.stages),this.stages.splice(this.stages.length-1,1)},this.addStage=function(){var a=new Object;a.ingredients="Ingredients\n",a.steps="Steps\n",a.order=this.stages.length,this.stages.push(a)}}angular.module("recipesApp",["ngRoute","ngResource","dropstore-ng","ui.date"]).config(["$httpProvider",function(a){delete a.defaults.headers.common["X-Requested-With"]}]).config(["$routeProvider",function(a){a.when("/recipe/:recipeId",{templateUrl:"views/recipe.html",controller:"RecipeCtrl",resolve:{recipeData:function(a){return a.promise}}}).when("/recipes",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{recipeData:function(a){return a.promise}}}).when("/",{templateUrl:"views/authenticate.html",controller:"AuthenticateCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("recipesApp").factory("recipe",["$q","dropstoreClient",function(a,b){var c=a.defer(),d=null;b.create({key:"awnio4fi56a0yjz"}).authenticate({interactive:!0}).then(function(a){return console.log("Got datastoreManager"),a.openDefaultDatastore()}).then(function(a){console.log("Got datastore"),d=a,c.resolve()});var e=function(a){console.log(a);var b=new Recipe;if("new"===a)b.new();else{var c=d.getTable("recipes"),e=c.get(a);console.log(e);var f=c.query({name:e.get("name")});console.log(f),b.fromRecords(f)}return b},f=function(){var a=new Array;console.log("getAll fired()");for(var b=d.getTable("recipes"),c=b.query({stageid:0}),e=0;e<c.length;e++){var f=c[e],g=new Recipe;g.fromRecord(f),a.push(g)}return a},g=function(a){var b=d.getTable("recipes"),c=a.toRecords();console.log(c);for(var e=new Array,f=0;f<c.length;f++){var g=c[f];if(g.id){console.log("Updating ",g.id);var h=b.get(g.id);h.update(g)}else{console.log("Inserting ",g);var i=b.insert(g);console.log("New Record",i),e.push(i)}}console.log(e),e.length>0&&a.fromRecords(e)},h=function(a){console.log("delRecipe ",a);for(var b=d.getTable("recipes"),c=b.get(a),e=b.query({name:c.get("name")}),f=0;f<e.length;f++){var c=e[f];c.deleteRecord()}},i=function(a){var b=d.getTable("recipes"),c=b.get(a);c.deleteRecord()};return{getAll:f,get:e,save:g,delRecipe:h,delStage:i,promise:c.promise}}]),angular.module("recipesApp").controller("MainCtrl",["$scope","recipe",function(a,b){a.recipes=[],a.authenticated=!1,a.recipes=b.getAll()}]),angular.module("recipesApp").controller("RecipeCtrl",["$scope","$routeParams","$location","recipe",function(a,b,c,d){a.recipe=d.get(b.recipeId),a.editor={},a.editor.enabled=!1,a.save=function(){a.disableEditor(),d.save(a.recipe),c.path("/recipes").replace()},a.enableEditor=function(){a.editor.enabled=!0},a.disableEditor=function(){a.editor.enabled=!1,console.log(a.editor.enabled)},a.del=function(){d.delRecipe(a.recipe.stages[0].id),c.path("/recipes").replace()},a.delStage=function(a){d.delStage(a)},a.addStage=function(){a.recipe.addStage()}}]);